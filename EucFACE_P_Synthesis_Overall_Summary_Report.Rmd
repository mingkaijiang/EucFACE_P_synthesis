---
title: "EucFACE Phosphorus Synthesis"
author: "Mingkai Jiang"
date: "20/02/2019"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

1. Description
---------------
This is a progress report of the EucFACE phosphorus (P) synthesis project. All results presented in this report are linked with the code and the data. 

This file attempts to summarize P-related pools, fluxes, concentrations, their treatment and inter-ring variability, and their temporal patterns. 

The objective of this project is to have a proper account of the P balance for the EucFACE experiment, and to investigate the P by CO2 interaction over time (if enough data is available).

All the data used in this study are available at HIEv (at least that's the goal). 

# 2. Methods 
### 2.1 Procedure 
This procedure is a snapshot of the work. It might be easier just to follow the codes. 

    - Create a list of variables for the P synthesis.
    - For each variable, only consider ring, date, and sometimes depth as independent factors.
    - Calculate P concentrations first.
    - With carbon/biomass related variables, calculate P pools and fluxes.
    - Calculate P budgeting variables, e.g. total standing P stock, P retranslocation coefficient, etc.
    - Make summary tables.

### 2.2 Variables
Here, I am summarizing all the P-related pool, flux and concentration variables. 
Currently, this list is in-comprehensive. Will update continuously as the project proceeds. 

    - Soil P concentration and pool (different chemical forms and accessibilities)
    - Microbial P concentration and pool
    - Mycorrhizal P concentration and pool
    - Canopy P concentration, production and pool
    - Wood P concentration, production and pool
    - Fineroot P concentration, production and pool
    - Coarse root P concentration, production and pool
    - Litterfall P concentration and production
    - P mineralization rate
    - Frass P concentration and production
    - Understorey P concentration, production and pool
    - Standing P stock
    - P requirement
    - Total P retranslocation 
    - Leaf P retranslocation coefficient
    - P uptake
    - P uptake / requirement
    - Mean residence time for P in plants
    - Standing PUE
    
### 2.3 How to derive P pools and fluxes based on concentration

The challenges with the P synthesis project is that, the P concentration measurements are sporadic and infrequent, we cannot simply taking the averages of concentration measurements and multiply it with the biomass data to obtain a P flux. 

For pool variables, i.e. wood P pool, we may be able to get away with using just one concentration measurement, given that the concentration of this pool is rather static and we only have one measurement in time avaiable after all. Taking this into consideration, we need to firstly check if the P concentration for a particular vegetation/soil component is static or not over time. If the P concentration is more or less static, we are fine with using average values to extrapolate. On the other hand, for pools that have rather fluctuating P concentration over time, we probably want to establish some sort of relationship with meteorological data for extrapolation purpose, or try to find the biomass peak and the P concentration associated with this time point, assuming that the product of biomass peak and P concentration returns the highest P pool within this year.  

For fluxes, we also need to see if the concentration is variable over time or not. For those that are more fluctuating with good data coverage, e.g. frass P concentration, we can simply calculate a monthly/quarterly P concentration value and use this value to exrtapolate with biomass changes for its corresponding P fluxes. For those that are fluctuating but with relatively less data coverage and with infrequent measurement frequency, e.g. leaflitter fall P concentration (4 time points over 3 years), we will have to assume the one time point is reflecting the annual P concentration, or otherwise we wouldn't be able to proceed. 

The other way to treat the complexity of variable P concentration over time is make a **sensitivity test**. We can use average P concentration, minimum and maximum P concentrations to respectively calculate the P pools and fluxes. This way we are probably more certain with regard to the range of uncertainties. 

# 3. P concentration calculations. 
``` {r, echo=FALSE, message=FALSE, warning=FALSE}
    ### source the functions to start the calculations.
    source("programs/prepare.R")
    
    ### assign aco2 and eco2 rings
    aCO2_rings <- c(2,3,6)
    eCO2_rings <- c(1,4,5)

```

### 3.1 Canopy P concentration
Canopy P concentration summarized by ring over the experimental period:
``` {r, echo=FALSE, fig.width = 7, fig.align="center"}
    ### calculate the variable
    canopy_p_concentration <- make_canopy_p_concentration_new(func=mean)
    canopy_p_concentration_min <- make_canopy_p_concentration(func=min)
    canopy_p_concentration_max <- make_canopy_p_concentration(func=max)

    ### make the ring over date plot
    p <- ggplot(canopy_p_concentration,
                aes(Date, PercP, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Canopy P Concentration (%)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)

```

Canopy P concentration summarized by CO2 treatment over the experimental period:

``` {r, echo=FALSE, fig.width = 7, fig.align="center"}
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        canopy_p_concentration[canopy_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        canopy_p_concentration[canopy_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the treatment over date plot
    p <- ggplot(canopy_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) + 
            xlab("Date") + ylab("Canopy P Concentration (%)")
    plot(p)

```

Visually, there is **no** CO2 treatment effect. 



### 3.2 Wood P concentration
Wood P concentration summarized by treatment, and we only have one date:

``` {r, echo=FALSE, fig.width = 7, fig.align="center"}
    ### calculate the variable
    wood_p_concentration <- make_wood_p_concentration(func=mean)
    wood_p_concentration_min <- make_wood_p_concentration(func=min)
    wood_p_concentration_max <- make_wood_p_concentration(func=max)
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        wood_p_concentration[wood_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        wood_p_concentration[wood_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the ring over date plot
    p <- ggplot(wood_p_concentration,
                aes(CO2, PercP)) +   
            geom_point(size = 5) +
            xlab("Treatment") + ylab("Wood P Concentration (%)")
    plot(p)

```

Visually, we can't distinguish the difference between CO2 treatment.


### 3.3 Fine root P concentration

There are multiple depths (i.e. 0-10cm, 10-30cm), currently we are averaging the concentrations over depths. 

Fineroot P concentration summarized by treatment over time:

``` {r, echo=FALSE, fig.width = 7, fig.align="center"}
    ### calculate the variable
    fineroot_p_concentration <- make_fineroot_p_concentration(func=mean)
    fineroot_p_concentration_min <- make_fineroot_p_concentration(func=min)
    fineroot_p_concentration_max <- make_fineroot_p_concentration(func=max)
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        fineroot_p_concentration[fineroot_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        fineroot_p_concentration[fineroot_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the treatment over date plot
    p <- ggplot(fineroot_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) + 
            xlab("Date") + ylab("Fineroot P Concentration (%)")
    plot(p)

```


### 3.4 Leaflitter P concentration
Measurements are taken for both scenesced leaves and leaflitter. 
Scenesced leaves are defined as those that are still (barely) attached to the tree, so there is a tree ID associated with each measurement. 
Leaflitter are those collected from the litter baskets.

Note, these samples were not taken on the same date; nor were they taken on the same dates as the fresh green leaves. 

We firstly need to distinguish the difference between the two. 

``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}
        ### calculate the variable
    leaflitter_p_concentration <- make_leaflitter_p_concentration_new(func=mean)

    ### make the ring over date plot
    p <- ggplot(leaflitter_p_concentration,
                aes(Date, PercP, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Leaflitter P Concentration (%)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

Next, both leaflitter and senesced leaves were grouped together as leaflitter. 
The CO2 by date plot is:

``` {r, echo=FALSE, fig.width = 7, fig.align="center"}
 
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        leaflitter_p_concentration[leaflitter_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        leaflitter_p_concentration[leaflitter_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the treatment over date plot
    p <- ggplot(leaflitter_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) + 
            xlab("Date") + ylab("Leaflitter P Concentration (%)")
    plot(p)

```


### 3.5 Understorey P concentration
There are two understorey species: Cymbopogon refractus and Microlaena stipoides. We need to differentiate P concentration difference between the two, as we don't have their relative abundance information. 

``` {r, echo=FALSE, fig.width = 7, fig.align="center"} 
    ### read in the file
    understorey_p_concentration <- make_understorey_p_concentration(func=mean)
    
    ### make the ring over date plot
    p <- ggplot(understorey_p_concentration,
                aes(Date, PercP, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Understorey P Concentration (%)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

Now, we can group both species together and plot understorey P concentration over time.

``` {r, echo=FALSE, fig.width = 7, fig.align="center"} 

    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        understorey_p_concentration[understorey_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        understorey_p_concentration[understorey_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }

    ### make the treatment over date plot
    p <- ggplot(understorey_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Understorey P Concentration (%)")
    plot(p)

```

### 3.6 Frass P concentration
``` {r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}
    ### calculate the variable
    frass_p_concentration <- make_frass_p_concentration(func=mean)
    frass_p_concentration_min <- make_frass_p_concentration(func=min)
    frass_p_concentration_max <- make_frass_p_concentration(func=max)
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        frass_p_concentration[frass_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        frass_p_concentration[frass_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the ring over date plot
    p <- ggplot(frass_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Frass P Concentration (%)")
    plot(p)

```

Frass production has a great time-series record of P concentration data available. We may be able to compute its CO2 by time trend and check its statistical significance. 



### 3.7 Microbial P concentration
``` {r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}
    ### calculate the variable
    microbial_p_concentration <- make_microbial_p_concentration(func=mean)
    microbial_p_concentration_min <- make_microbial_p_concentration(func=min)
    microbial_p_concentration_max <- make_microbial_p_concentration(func=max)
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        microbial_p_concentration[microbial_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        microbial_p_concentration[microbial_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the ring over date plot
    p <- ggplot(microbial_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Microbial P Concentration (%)")
    plot(p)

```

Note, this is based on 0-10cm data only, as this is the only depth with data available. It's not consistent with any other soil related variables (0-30cm). 

### 3.8 Soil P concentration
``` {r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}
    ### calculate the variable
    soil_p_concentration <- make_soil_p_concentration(func=mean)
    soil_p_concentration_min <- make_soil_p_concentration(func=min)
    soil_p_concentration_max <- make_soil_p_concentration(func=max)
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        soil_p_concentration[soil_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        soil_p_concentration[soil_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the ring over date plot
    p <- ggplot(soil_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Soil P Concentration (%)")
    plot(p)

```

Note, soil data are available at various depths (0-10, 10-20 and 20-30cm), and data were not collected for all depths at different time points. 

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"} 

    soil_bulk_density <- make_soil_bulk_density()
    soil_c_pool <- make_soil_c_pool(soil_bulk_density)

    ### make the depth over date plot
    p <- ggplot(soil_c_pool,
                aes(Date, soil_carbon_pool, color=factor(ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Soil C Pool (g C m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

It is observed from the above C pool at various depths that, only two dates have C pool measured over three depths. We need to come up with a way to either extrapolate based on depth profile or to remove dates without 3-depth measurements. 

### 3.9 Soil Phosphate P concentration
Averaged across multiple depths, without consideration of assigning relative weight score. Need to update this calculation later. 

Also, soil phosphate P is the PO4-P, not PO4 concentration. 

Further, phosphate measurements were taken at quarterly timestep, but it should not reflect the accumulation of phosphate production over time time frame (I think). But this needs to be confirmed by soil people, as I am not sure whether the measurements excluded plants and mycorrhizaes. Even with exclusion, we still can't be sure this concentration reflects the total soil phosphate production over time period, as rainfall and hence leaching may also affect the concentration. 

``` {r, echo=FALSE, message=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}
    ### calculate the variable
    soil_phosphate_concentration <- make_soil_phosphate_concentration(func=mean)
    soil_phosphate_concentration_min <- make_soil_phosphate_concentration(func=min)
    soil_phosphate_concentration_max <- make_soil_phosphate_concentration(func=max)
    
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        soil_phosphate_concentration[soil_phosphate_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        soil_phosphate_concentration[soil_phosphate_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the ring over date plot
    p <- ggplot(soil_phosphate_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Soil P Concentration (%)")
    plot(p)

```

Note: Soil PO4 data is only available for top 0-10 cm of the soil!

What happens at that time point after 2015? Is it a leaching-induced event?


### 3.10 Mycorrhizal P concentration
We currently don't have mycorrhizal data available yet. 

# 4. Related variables to compute P pools and fluxes. 

### 4.1 Soil bulk density across depths
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    soil_bulk_density <- make_soil_bulk_density()

    ### make the plot
    p <- ggplot(soil_bulk_density,
                aes(ring, bulk_density_kg_m3, color=factor(Depth))) +   
            geom_point(size = 5) +
            xlab("Ring") + ylab("Bulk density (kg m-3)")
    plot(p)


```

### 4.2 Soil P mineralization rate
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    soil_p_mineralization <- make_soil_p_mineralization_flux(soil_bulk_density)

    ### make the plot
    # compare eCO2 and aCO2 treatment
    soil_p_mineralization[soil_p_mineralization$Ring == 1, "CO2"] <- "eCO2"
    soil_p_mineralization[soil_p_mineralization$Ring == 4, "CO2"] <- "eCO2"
    soil_p_mineralization[soil_p_mineralization$Ring == 5, "CO2"] <- "eCO2"
    
    soil_p_mineralization[soil_p_mineralization$Ring == 2, "CO2"] <- "aCO2"
    soil_p_mineralization[soil_p_mineralization$Ring == 3, "CO2"] <- "aCO2"
    soil_p_mineralization[soil_p_mineralization$Ring == 6, "CO2"] <- "aCO2"
    
    
    p <- ggplot(soil_p_mineralization, aes(Date, p_mineralization_mg_m2_d, color=factor(CO2))) +   
        geom_point(size = 5) +
        xlab("Date") + ylab("P mineralization rate (mg m-2 d-1)") + 
        ggtitle("P mineralization rate over time") 
    plot(p)


```

### 4.3 Leaf P retranslocation coefficient
We need to think about data collected from the same time point. For now, because dates don't match, we just take the averages. 

``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    source("programs/summary_variables/make_leaf_p_retranslocation_coefficient_new.R")
    leaf_p_retrans_coefficient <- make_leaf_p_retranslocation_coefficient_new()

    p <- ggplot(leaf_p_retrans_coefficient, aes(CO2, retrans_coef, color=factor(Ring))) +   
                geom_point(size = 5) +
                xlab("Treatment") + ylab("Leaf P retranslocation coefficient (%)") 
    plot(p)

```


### 4.4 C fraction for frass production
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    frass_c_fraction <- make_frass_c_fraction()


    ### make the plot
    p <- ggplot(frass_c_fraction,
                aes(Date, frass_c_fraction, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Fraction of C in Frass (%)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 4.5 Aboveground leaf biomass, litterfall and frass production
``` {r, echo = FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}
   # hidden variables
    #### Canopy related variables (SLA, LAI, Canopy biomass)
    lai_variable <- make_lai_variable()
    sla_variable <- make_sla_variable()
    canopy_biomass_pool <- make_canopy_biomass_pool(lai_variable, sla_variable, sla_option="variable")
    
    ### make the plot
    p <- ggplot(canopy_biomass_pool,
                aes(Date, leaf_pool, color=factor(Ring))) +   
            geom_point(size = 0.5) + geom_line() + 
            xlab("Date") + ylab("Canopy biomass (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
    

```

The above figure is a time-series canopy biomass plot, derived based on SLA and LAI measurements. 

Assuming C fraction of 0.5, we can derive the canopy C pool, as:

``` {r, echo=FALSE, fig.width = 7, fig.align="center"}
    
    ### make the plot
    p <- ggplot(canopy_biomass_pool,
                aes(Date, leaf_pool*0.5, color=factor(Ring))) +   
            geom_point(size = 0.5) + geom_line() + 
            xlab("Date") + ylab("Canopy C pool (g C m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)

```

<br/>
Next, I calculate litter fall fluxes:

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}
    #### Litter production (leaf, twig, bark, seed)
    litter_c_production_flux <- make_litter_c_flux(c_fraction)

    leaflitter_c_production_flux <- litter_c_production_flux[,c("Date", "Ring", "leaf_flux", "Start_date", "End_date", "Days")]
    twiglitter_c_production_flux <- litter_c_production_flux[,c("Date", "Ring", "twig_flux", "Start_date", "End_date", "Days")]
    barklitter_c_production_flux <- litter_c_production_flux[,c("Date", "Ring", "bark_flux", "Start_date", "End_date", "Days")]
    seedlitter_c_production_flux <- litter_c_production_flux[,c("Date", "Ring", "seed_flux", "Start_date", "End_date", "Days")]
    
    plotDF <- melt(litter_c_production_flux, id.vars = 1:2, measure= 3:6)
    
    ### make the plot
    p <- ggplot(plotDF,
                aes(Date, value, color=factor(variable))) +   
            geom_point(size = 0.5, aes(color=factor(Ring))) + geom_smooth() + 
            xlab("Date") + ylab("Litterfall (mg C m-2 d-1)") 
    plot(p)
    
```

<br/>
Finally, frass production flux is:

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}
 
    #### Frass production
    frass_c_production_flux <- make_frass_c_production_flux()

    ### make the plot
    p <- ggplot(frass_c_production_flux,
                aes(Date, frass_production_flux, color=factor(Ring))) +   
            geom_point(size = 0.5) + geom_line() + 
            xlab("Date") + ylab("Frass C production (mg C m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
    
```


### 4.6 Root biomass and production
First, we calculate fine root c pool: 

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}
    #### Fineroot pools and production
    # this is total fineroot biomass for 0-30cm
    # currently implemented whole plant C fraction
    # need to update with fineroot specific C fraction value
    fineroot_c_pool <- make_fineroot_c_pool(c_fraction_fr)
    fineroot_c_production_flux <- make_fineroot_c_production_flux(c_fraction_fr)
    
    ### make the plot
    p <- ggplot(fineroot_c_pool,
                aes(Date, fineroot_pool, color=factor(Ring))) +   
            geom_point(size = 0.5) + geom_line() + 
            xlab("Date") + ylab("Fineroot C pool (g C m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
    
```

<br/>
Fineroot production flux is:

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}

    ### make the plot
    p <- ggplot(fineroot_c_production_flux,
                aes(Date, fineroot_production_flux, color=factor(Ring))) +   
            geom_point(size = 0.5) + geom_line() + 
            xlab("Date") + ylab("Fineroot C production (mg C m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
    
```

<br/>

Now, I am comparing coarse root c pools based on two methods. 

Method 1:

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}

    coarse_root_c_pool <- make_coarse_root_pool(c_fraction, fr_pool=fineroot_c_pool) 
    coarse_root_c_flux <- make_coarse_root_production_flux(coarse_root_c_pool) 

    ### make the plot
    p <- ggplot(coarse_root_c_pool,
                aes(Date, coarse_root_pool, color=factor(Ring))) +   
            geom_point(size = 2.5) + geom_line() + 
            xlab("Date") + ylab("Coarse root C pool (g C m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
    
```

<br/>

### 4.7 Understorey C pool

Here, understorey C biomass is estimated based on Varsha's clip data. 

``` {r, echo=FALSE, warning=FALSE, message=FALSE}
    
    #### Understorey aboveground biomass 
    understorey_c_pool <- make_understorey_aboveground_c_pool(c_fraction_ud,
                                                              strip_area)
    
    understorey_c_flux <- make_understorey_aboveground_production_flux(c_fraction_ud)
```


Now, I am making a different estimate of understorey C biomass, based on Matthias's stereo camera estimate of height.

``` {r, echo=FALSE, warning=FALSE, message=FALSE}
    
    #### Understorey aboveground biomass 
    #understorey_c_pool_2 <- make_understorey_aboveground_c_pool_2(c_fraction_ud)
    
    #understorey_c_flux_2 <- make_understorey_aboveground_production_flux_2(c_fraction_ud)
```

Now, we need to compare the two biomass estimates:

Harvest estimate:
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}

    #p1 <- ggplot(understorey_c_pool_2,
    #            aes(Date, Total_g_C_m2, color=factor(Ring))) +   
    #        geom_point(size = 2.5) + geom_line() + 
    #        xlab("Date") + ylab("Understorey C pool (g C m-2)") + 
    #        scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
    #                                    "#FF4040", "#8B0000", "#0000FF"))
    #plot(p1)
    
```

Stereo Camera estimate:

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}
    p2 <- ggplot(understorey_c_pool,
                aes(Date, Total_g_C_m2, color=factor(Ring))) +   
            geom_point(size = 2.5) + geom_line() + 
            xlab("Date") + ylab("Understorey C pool (g C m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p2)
    
```


Ring averaged comparison:

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}
    source("programs/summary_variables/make_understorey_pool_size_comparison.R")

    #plotDF <- make_understorey_pool_size_comparison(understorey_c_pool,
    #                                                understorey_c_pool_2,
    #                                                plotting = F)

    #p <- ggplot(plotDF, aes(Date,value)) + 
    #    geom_point() + 
    #    stat_smooth() +
    #    facet_wrap(~variable)
    
    #plot(p)
   
```

DF1 is Varsha's clip harvest and DF2 is Matthias's stereo camera estimates. 

The general temporal pattern is similar, but the biomass size is different. This difference is possibly due to two factors: 1) Clipping harvest induces re-growth, and possibly the re-grown biomass is not at the mature stage; 2) Harvest data only include grasses and herbes, but stereo camera may additional include shrub data. 

Varsha's clipping data provides % of live and % of dead biomass information. We could assign % P data to live biomass only, and assume 100% P retranslocation before shoot tissue sceneced. This might lower the understorey P pool. But the exact extent of the retranslocation rate remains unclear, and there is really no literature value on this.

``` {r, echo=F, warning=F, message=F, fig.width = 7, fig.align="center"}
    #source("programs/summary_variables/make_understorey_percent_live_estimate.R")
    #understorey_live_percent <- make_understorey_percent_live_estimate()

    #p <- ggplot(understorey_live_percent, aes(Date, percent_live, color=factor(Ring))) +
    #    geom_line() + 
    #    xlab("Date") + ylab("Understorey % live") + 
    #        scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
    #                                    "#FF4040", "#8B0000", "#0000FF"))
    #    

```

To look at growth estimate based on % cover change over a 15-d window, we can evaluate whether biomass estimated based on quarterly harvest is indicative of the mature biomass or not. 

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}
    #plotDF <- make_understorey_aboveground_growth_estimate(plotting = F)

    #p <- ggplot(plotDF, aes(Date, Daily_growth, color=factor(Ring))) +   
    #        geom_point(size = 5) + geom_line() + 
    #        xlab("Date") + ylab("Understorey Growth (% cover change / day)") + 
    #        scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
    #                                    "#FF4040", "#8B0000", "#0000FF"))
        
    #plot(p)
    
```

This result indicates, growth estimated based on percent coverage fluctuates within a range of 1 to -1 % on a daily basis. So the harvest data over a quarterly interval may not be indicative of the true biomass. However, question also remains, as to how good a representation the change in % coverage is for biomass growth. 

Now, we need to look at understorey production flux estimates, to make sure they are at least in the same magnitude.

Stereo camera estimates:

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}

    #p1 <- ggplot(understorey_c_flux_2,
    #            aes(Date, understorey_production_flux, color=factor(Ring))) +   
    #        geom_point(size = 2.5) + geom_line() + 
    #        xlab("Date") + ylab("Understorey C production (mg C m-2 d-1)") + 
    #        scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
    #                                    "#FF4040", "#8B0000", "#0000FF"))
    #plot(p1)
    
```

Harvest flux:

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}

    p2 <- ggplot(understorey_c_flux,
                aes(Date, understorey_production_flux, color=factor(Ring))) +   
            geom_point(size = 2.5) + geom_line() + 
            xlab("Date") + ylab("Understorey C production (mg C m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p2)
    
```

Huge difference for understorey production estimates. Harvest data is more static and does not reflect understorey mortality and turnover. 

However, if we look at the total annual production, values don't differ that much.

``` {r}
#test1 <- with(understorey_c_flux, sum(understorey_production_flux*Days)/sum(Days)) * 365/1000
#test2 <- with(understorey_c_flux_2, sum(understorey_production_flux*Days)/sum(Days)) * 365/1000

#print(test1)

#print(test2)

```

### 4.8 wood C pool
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}
    
    # year 2011-12 data on local directory
    wood_c_pool <- make_wood_c_pool(ring_area=FACE_ring_area,
                                c_frac=c_fraction)
    
    
    #### Wood C production
    wood_c_production <- make_wood_production_flux(wood_c_pool)
    
    ### make the plot
    p <- ggplot(wood_c_pool,
                aes(Date, wood_pool, color=factor(Ring))) +   
            geom_point(size = 2.5) + geom_line() + 
            xlab("Date") + ylab("Wood C (g C m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)

```

<br/>

Wood pool decreases over certain periods for certain rings (e.g. ring 6, 5, 2). I investigated this by looking at the raw diameter data. Notably, only 1 tree was marked as mortality in ring 6 (tree 608); however, we don't know when it died. Raw diameter data indicates that, decrease in diameter is common in the measurements. Hence, mortality is not driving this decrease in wood pool pattern. 

On the other hand, we still need to properly account for mortality, or standing dead pool. Because the data only marked one tree as dead, we need to 1) check if any additional death data is avaialble, and 2) make them a separate pool as dead wood, and make an additional total wood pool. 

Next, wood C production is:

``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}
    ### make the plot
    p <- ggplot(wood_c_production,
                aes(Date, wood_production_flux, color=factor(Ring))) +   
            geom_point(size = 2.5) + geom_line() + 
            xlab("Date") + ylab("Wood C production (mg C m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)

```

Because wood pool may either increase or decrease over a certain measurement period, wood production can be either positive or negative. 


### 4.9 Standing dead wood pool and flux
``` {r, echo=FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.align="center"}
    
    # year 2011-12 data on local directory
    #standing_dead_c_pool <- make_standing_dead_c_pool(ring_area=FACE_ring_area,
    #                                                  c_frac=c_fraction)
    
    
    #### Wood C production
    #standing_dead_c_flux <- make_standing_dead_c_flux(standing_dead_c_pool)
    
        ### make the plot
    #p <- ggplot(standing_dead_c_pool ,
    #            aes(Date, wood_pool, color=factor(Ring))) +   
    #        geom_point(size = 2.5) + geom_line() + 
    #        xlab("Date") + ylab("Standing dead wood C (g C m-2)") + 
    #        scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
    #                                    "#FF4040", "#8B0000", "#0000FF"))
    #plot(p)

```

### 4.10 Microbial pool
``` {r, echo=F, warning=F, message=F, fig.width = 7, fig.align="center"}
    # first, compute the microbial c pool as we will need it for summary purpose
    #microbial_c_pool <- make_microbial_c_pool(soil_bulk_density)


````

A second dataset for microbial C and N pool is available from Laura and Yolima. Here we are comparing the two methods for each ring. 

``` {r, echo=F, warning=F, message=F, fig.width = 7, fig.align="center"}
    #microbial_c_pool2 <- make_microbial_pool2(soil_bulk_density)
    #micro <- summaryBy(Cmic_g_m2~ring, data=microbial_c_pool, FUN=mean, keep.names=T, na.rm=T)
    #micro$micro2 <- microbial_c_pool2$microbial_c_pool
    #colnames(micro) <- c("Ring", "Microbial_C_pool1", "Microbial_C_pool2")
    #plotDF <- melt(micro, id="Ring")
    
    
   ### make the plot
    #p <- ggplot(plotDF,
    #            aes(Ring, value)) +   
    #        geom_bar(stat = "identity", aes(fill=variable),
    #                 position="dodge") +
    #        xlab("Ring") + ylab("Microbial C Pool (g C m-2)")
    #plot(p)
    
```



# 5. P pools and fluxes

### 5.1 Soil P pool
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    soil_p_pool <- make_soil_p_pool(p_conc=soil_p_concentration,
                                    bk_density=soil_bulk_density)

    ### make the plot
    p <- ggplot(soil_p_pool,
                aes(Date, soil_p_g_m2, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() +
            xlab("Date") + ylab("Soil P pool (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.2 Soil PO4-P pool
Note, this pool is more readily available to plants as the microbial p pool needs one extra step when extracting.
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    soil_phosphate_pool <- make_soil_phosphate_pool(p_conc=soil_phosphate_concentration,
                                                    bk_density=soil_bulk_density)

    ### make the plot
    p <- ggplot(soil_phosphate_pool,
                aes(Date, soil_phosphate_p_g_m2, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Soil PO4-P production (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.3 Microbial P pool

Note, this is for top 10 cm of the soil. 

``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    microbial_c_pool <- make_microbial_c_pool(soil_bulk_density)

    microbial_p_pool <- make_microbial_p_pool(p_conc=microbial_p_concentration,
                                              bk_density=soil_bulk_density)

    ### make the plot
    p <- ggplot(microbial_p_pool,
                aes(Date, microbial_p_g_m2, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Soil PO4-P production (g m-2)")
    plot(p)


```

This pool seems very large, especially consideration its concentration is very small (compared to wood for example). It implies that the biomass is enormous. Checking data description on HIEv, the microbial P concentration was "Fumigation extraction with Bray P AQ2 determination of PO4", in the unit og ug g-1. Essentially, the calculation was done by P conc * soil bulk, not P conc by biomass. Check with Cat to see if this makes sense. 

### 5.4 Mycorrhizal P pool

### 5.5 Canopy P pool
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    dLEAF_litter_flux <- make_dLAI_litter(litter=leaflitter_c_production_flux, sla_variable=sla_variable)

    canopy_p_pool <- make_canopy_p_pool_smoothed(biom=dLEAF_litter_flux)


    ### make the plot
    p <- ggplot(canopy_p_pool,
                aes(Date, leaf_p_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Canopy P (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.6 Wood P pool
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    wood_p_pool <- make_wood_p_pool(p_conc=wood_p_concentration,
                                    c_pool=wood_c_pool,
                                    case_consideration="sapwood")

    ### make the plot
    p <- ggplot(wood_p_pool,
                aes(Date, wood_p_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Wood P (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

We have only concentration measurement for one point in time. Assume this rate applies to all biomass. 
Check, why inconsistent time points. 

Also, we only took sapwood to calculate wood p, assuming that all heartwood P is retranslocated (i.e. zero P concentration).

### 5.7 Fine root P pool
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    fineroot_p_pool <- make_fineroot_p_pool(p_conc=fineroot_p_concentration,
                                            c_pool=fineroot_c_pool)

    ### make the plot
    p <- ggplot(fineroot_p_pool,
                aes(Date, fineroot_p_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Fineroot P (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.8 Coarse root P pool
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    coarse_root_p_pool <- make_coarse_root_p_pool(p_conc=wood_p_concentration,
                                                c_pool=coarse_root_c_pool,
                                                c_frac=c_fraction)


    ### make the plot
    p <- ggplot(coarse_root_p_pool,
                aes(Date, coarse_root_p_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Coarse root P (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.9 Understorey aboveground P pool
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    understorey_litter_p_concentration <- make_understorey_litter_p_concentration(func=mean)

    understorey_p_pool <- make_understorey_p_pool(p_conc=understorey_p_concentration,
                                              p_lit_conc=understorey_litter_p_concentration,
                                              c_pool=understorey_c_pool,
                                              c_frac=c_fraction_ud,
                                              live_or_total = "Total")

    ### make the plot
    p <- ggplot(understorey_p_pool,
                aes(Date, understorey_p_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Understorey P (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

Understorey P pool, assume both species contributed equally. Also because p_conc and c_pool do not match in time, we are taking the average of p_conc and apply it to c_pool. 

Here we are using harvest data (taken at quarterly timestep) to extrapolate for P pool. This estimate is lower than the Stereo camera estimates (non-destructive method), but it gives us the production term. To be consistent with the production term, here we are using harvest estimate. 

The harvest data also provides information on % live and % dead. As such, understorey P pool can be extrapolated based on %P by total biomass or %P by live biomass methods.

The understorey P production is estimated based on total biomass and % P. 


### 5.10 Canopy P flux
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    canopy_c_production_flux <- leaflitter_c_production_flux

    ### considered both change in LAI and litterfall
    canopy_c_production_flux_new <- make_canopy_c_production_flux_new(inDF=dLEAF_litter_flux)

    canopy_p_flux <- make_canopy_p_production_new(c_flux=canopy_c_production_flux_new,
                                                  c_frac=c_fraction)

    ### make the plot
    p <- ggplot(canopy_p_flux,
                aes(Date, canopy_p_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Wood P production (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.11 Wood P flux
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    wood_p_flux <- make_wood_p_production(p_conc=wood_p_concentration,
                                    c_flux=wood_c_production)

    ### make the plot
    p <- ggplot(wood_p_flux,
                aes(Date, wood_p_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Wood P production (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.12 Fineroot production P flux
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    fineroot_p_production <- make_fineroot_p_production(p_conc=fineroot_p_concentration,
                                                        c_flux=fineroot_c_production_flux)
    ### make the plot
    p <- ggplot(fineroot_p_production,
                aes(Date, fineroot_p_flux_mg_m2_d, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Fineroot P production (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.13 Coarse root production P flux
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    coarse_root_p_flux <- make_coarse_root_p_flux(p_conc=wood_p_concentration,
                                                c_flux=coarse_root_c_flux,
                                                c_frac=c_fraction)

    ### make the plot
    p <- ggplot(coarse_root_p_flux,
                aes(Date, coarse_root_p_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Coarse P production (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```


### 5.14 Leaflitter P flux
``` {r, echo=FALSE, warning=FALSE, message = FALSE, fig.width = 7, fig.align="center"}

    leaflitter_p_flux <- make_leaflitter_p_flux(p_conc=leaflitter_p_concentration)  

    ### make the plot
    p <- ggplot(leaflitter_p_flux,
                aes(Date, leaflitter_p_flux_mg_m2_d, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Leaf litter P (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p) 


```

### 5.15 Fineroot litter P flux

This is estimated based on fine root c production flux, fineroot p concentration, and an bulk estimate of fine root P retranslocation coefficient. 

``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    fineroot_litter_p_flux <- make_fineroot_litter_p_production(p_conc=fineroot_p_concentration,
                                                            c_flux=fineroot_c_production_flux,
                                                            p_retrans=0.5)
    ### make the plot
    p <- ggplot(fineroot_litter_p_flux,
                aes(Date, fineroot_litter_p_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Fineroot Litter P production (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```


### 5.16 other aboveground litter P flux
``` {r, echo=FALSE, warning=FALSE, message = FALSE, fig.width = 7, fig.align="center"}

    #other_litter_p_flux <- make_other_litter_p_flux(p_conc=wood_p_concentration)  

    #### make the plot
    #p <- ggplot(other_litter_p_flux,
    #            aes(Date, other_litter_p_flux_mg_m2_d, color=factor(Ring))) +   
    #        geom_point(size = 5) + geom_line() + 
    #        xlab("Date") + ylab("Other litter P (mg m-2 d-1)") + 
    #        scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
    #                                    "#FF4040", "#8B0000", "#0000FF"))
    #plot(p)


```

### 5.17 Frass production P flux
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    frass_p_production <- make_frass_p_production_flux(p_conc=frass_p_concentration,
                                                   c_flux=frass_c_production_flux,
                                                   c_frac=frass_c_fraction)

    ### make the plot
    p <- ggplot(frass_p_production,
                aes(Date, frass_p_flux_mg_m2_d, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Frass P production (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

### 5.18 Understorey production P flux
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    understorey_p_flux <- make_understorey_p_flux(p_conc=understorey_p_concentration,
                                              c_flux=understorey_c_flux,
                                              c_frac=c_fraction_ud)

    ### make the plot
    p <- ggplot(understorey_p_flux,
                aes(Date, understorey_p_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() +
            xlab("Date") + ylab("Understorey P production (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

Used Varsha's harvest data to extrapolate. 

### 5.19 Soil mineralization P flux
``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    soil_p_mineralization <- make_soil_p_mineralization_flux(soil_bulk_density)

    ### make the plot
    p <- ggplot(soil_p_mineralization,
                aes(Date, p_mineralization_mg_m2_d, color=factor(Ring))) +   
            geom_point(size = 5) + 
            xlab("Date") + ylab("Soil P mineralization (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)


```

Positive values indicate minerlization, negative indicate immobilization. 

Shun's GCB paper indicates that P mineralization rate was higher under eCO2, but here it is lower. 

However, the exact texts in Shun's paper were: "eCO2 was also associated with faster nutrient turnover rates in the first six months of the experiment, with higher N (+175%) and P (+211%) mineralization rates compared to ambient rings, ***although this difference did not persist***."

Hence, CO2 treatment effct is only there for the first few points! 


### 5.20 Standing dead p pool and fluxes

Standing dead p pool

``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    #standing_dead_p_pool <- make_wood_p_pool(p_conc=wood_p_concentration,
    #                                     c_pool=standing_dead_c_pool,
    #                                     case_consideration = "sapwood")
#
    #### make the plot
    #p <- ggplot(standing_dead_p_pool,
    #            aes(Date, wood_p_pool, color=factor(Ring))) +   
    #        geom_point(size = 5) + 
    #        xlab("Date") + ylab("Standing dead P (g m-2)") + 
    #        scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
    #                                    "#FF4040", "#8B0000", "#0000FF"))
    #plot(p)


```

Standing dead p flux

``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}

    #standing_dead_p_flux <- make_standing_dead_p_flux(p_conc=wood_p_concentration,
    #                                           c_flux=standing_dead_c_flux)
#
    #### make the plot
    #p <- ggplot(standing_dead_p_flux,
    #            aes(Date, wood_p_flux, color=factor(Ring))) +   
    #        geom_point(size = 5) + 
    #        xlab("Date") + ylab("Standing dead P flux (mg m-2 d-1)") + 
    #        scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
    #                                    "#FF4040", "#8B0000", "#0000FF"))
    #plot(p)


```


# 6. Summary tables
``` {r, echo=FALSE, message=FALSE, warning=FALSE}
    library(knitr)

```

### P concentration table
Below, I summarize the per ring, per treatment table for all P concentration variables. 
Rings 2, 3, 6 are ambient CO2 rings, and rings 1, 4, 5 are elevated CO2 rings. 

``` {r, echo=FALSE, warning=FALSE, message=FALSE} 
    soil_hedley_p_concentration <- make_soil_hedley_p_concentration(func=mean)

    soil_p_pool_hedley <- make_soil_p_pool_hedley(p_conc=soil_hedley_p_concentration,
                                                            bk_density=soil_bulk_density)


    source("programs/summary_tables/make_conc_summary_table_by_treatment.R")
    summary_table_concentration_by_treatment <- make_conc_summary_table_by_treatment()
    
    # make the table looks nicer
    # colnames(summary_table_concentration_by_treatment)[1] <- "Variable"
    summary_table_concentration_by_treatment[,2:7] <-  round(summary_table_concentration_by_treatment[,2:7], 3)
    
    kable(summary_table_concentration_by_treatment)

```

<br/>
<br/>
<br/>
<br/>

### P pool table
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    source("programs/summary_tables/make_pool_summary_table_by_treatment.R")
    summary_table_pool_by_treatment <- make_pool_summary_table_by_treatment()
    
    # make the table looks nicer
    # colnames(summary_table_pool_by_treatment)[1] <- "Variable"
    summary_table_pool_by_treatment[,2:7] <- round(summary_table_pool_by_treatment[,2:7], 3)
    
    kable(summary_table_pool_by_treatment)

```

### C pool table

Here I am summarizing all the C pools used for P calculations:
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 

    mycorrhizal_c_pool <- make_mycorrhizal_c_pool(microbial_c_pool)

    # now make the summary
    source("programs/summary_tables/make_c_pool_summary_table_by_treatment.R")
    summary_table_c_pool_by_treatment <- make_c_pool_summary_table_by_treatment()
    
    # make the table looks nicer
    # colnames(summary_table_c_pool_by_treatment)[1] <- "Variable"
    summary_table_c_pool_by_treatment[,2:9] <- round(summary_table_c_pool_by_treatment[,2:9], 1)
    
    kable(summary_table_c_pool_by_treatment)

```

### P flux table
Now, I summarize all P flux variables:
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 

    twig_litter_p_flux <- make_twiglitter_p_flux(p_conc=wood_p_concentration, litter_flux=twiglitter_c_production_flux)  
    bark_litter_p_flux <- make_barklitter_p_flux(p_conc=wood_p_concentration, litter_flux=barklitter_c_production_flux)  
    seed_litter_p_flux <- make_seedlitter_p_flux(p_conc=wood_p_concentration, litter_flux=seedlitter_c_production_flux)  

    understorey_litter_c_flux <- make_understorey_litter_flux(c_fraction_ud)


    understorey_litter_p_flux <- make_understorey_litter_p_flux(p_conc=understorey_p_concentration,
                                              c_flux=understorey_litter_c_flux,
                                              c_frac=c_fraction_ud)

    source("programs/summary_tables/make_flux_summary_table_by_treatment.R")
    summary_table_flux_by_treatment <- make_flux_summary_table_by_treatment()
    
    # make the table looks nicer
    # colnames(summary_table_flux_by_treatment)[1] <- "terms"
    summary_table_flux_by_treatment[,2:7] <- round(summary_table_flux_by_treatment[,2:7], 3)
    
    kable(summary_table_flux_by_treatment)

```

### C flux table

Now, we need all the C flux variables to make reference of:
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    source("programs/summary_tables/make_c_flux_summary_table_by_treatment.R")
    summary_table_c_flux_by_treatment <- make_c_flux_summary_table_by_treatment()
    
    # make the table looks nicer
    # colnames(summary_table_flux_by_treatment)[1] <- "terms"
    summary_table_c_flux_by_treatment[,2:9] <- round(summary_table_c_flux_by_treatment[,2:9], 3)
    
    kable(summary_table_c_flux_by_treatment)

```

<br/>
<br/>

### P budget

#### total P budget

``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    source("programs/summary_variables/make_total_p_budgeting_variables.R")
    summary_table_total_p_budgets <- make_total_p_budgeting_variables()

    kable(summary_table_total_p_budgets)

```

Note: total P retranslocation includes leaf and fineroot retranslocation, plus wood P increment and understorey. Understorey part is a guess retranslocation coefficient, as there is no literature value on Microlaena P retranslocation. 

<br/>
<br/>

#### overstorey P budget

``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    source("programs/summary_variables/make_overstorey_p_budgeting_variables.R")
    summary_table_overstorey_p_budgets <- make_overstorey_p_budgeting_variables()

    kable(summary_table_overstorey_p_budgets)

```

<br/>
<br/>

#### understorey P budget

``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    source("programs/summary_variables/make_understorey_p_budgeting_variables.R")
    summary_table_understorey_p_budgets <- make_understorey_p_budgeting_variables()

    kable(summary_table_understorey_p_budgets)

```

<br/>
<br/>

### CP ratios for all pools

This time-invariant CP ratio based on all data. 

``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    source("programs/summary_tables/make_cp_ratios.R")
    summary_cp_ratios <- make_cp_ratios(c_pool=summary_table_c_pool_by_treatment,
                                        p_pool=summary_table_pool_by_treatment)
    
    kable(summary_cp_ratios)

```

<br/>
<br/>

### Comparing CP ratio for microbial pool inside and outside the rings
``` {r, echo = FALSE, warning=FALSE, message=FALSE} 
    source("programs/check_variables/check_microbial_pool_CP_ratios.R")
    summary_microbial_pool_comparison <- check_microbial_pool_CP_ratios(c_pool=summary_table_c_pool_by_treatment,
                                                        p_pool=summary_table_pool_by_treatment)
    
    kable(summary_microbial_pool_comparison)

```

<br/>
<br/>


# 7. Nitrogen related data to understand P limitation
### 7.1 Concentrations
#### Canopy N concentration
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    canopy_n_concentration <- make_canopy_n_concentration()

    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        canopy_n_concentration[canopy_n_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        canopy_n_concentration[canopy_n_concentration$Ring == i, "CO2"] <- "eCO2"
    }

    ### make the treatment over date plot
    p <- ggplot(canopy_n_concentration,
                aes(Date, PercN, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Canopy N Concentration (%)")
    plot(p)

```


#### Frass N concentration
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    frass_n_concentration <- make_frass_n_concentration()

    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        frass_n_concentration[frass_n_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        frass_n_concentration[frass_n_concentration$Ring == i, "CO2"] <- "eCO2"
    }

    ### make the treatment over date plot
    p <- ggplot(frass_n_concentration,
                aes(Date, PercN, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Frass N Concentration (%)")
    plot(p)

```

#### Soil N concentration
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    soil_n_concentration <- make_soil_n_concentration()

    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        soil_n_concentration[soil_n_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        soil_n_concentration[soil_n_concentration$Ring == i, "CO2"] <- "eCO2"
    }

    ### make the treatment over date plot
    p <- ggplot(soil_n_concentration,
                aes(Date, PercN, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Soil N Concentration (%)")
    plot(p)

```

#### Soil Inorganic N concentration

This concentration can be obtained based on three possible datasets:

    - Lysimeter 
    - Extractable
    - IEM

Not sure which to use, but to be consistent with phosphate P data, I decided to use the extractable dataset. 

This pool includes nitrate-N, ammonia-N. 

``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    soil_inorganic_n_concentration <- make_soil_inorganic_n_concentration()

    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        soil_inorganic_n_concentration[soil_inorganic_n_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        soil_inorganic_n_concentration[soil_inorganic_n_concentration$Ring == i, "CO2"] <- "eCO2"
    }

    ### make the treatment over date plot
    p <- ggplot(soil_inorganic_n_concentration,
                aes(Date, Total_PercN, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Soil Inorganic N Concentration (%)")
    plot(p)

```


#### Understorey N concentration
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    understorey_n_concentration <- make_understorey_n_concentration()

    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        understorey_n_concentration[understorey_n_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        understorey_n_concentration[understorey_n_concentration$Ring == i, "CO2"] <- "eCO2"
    }

    ### make the treatment over date plot
    p <- ggplot(understorey_n_concentration,
                aes(Date, PercN, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Understorey N Concentration (%)")
    plot(p)

```

<br/>

### 7.2 Pools and fluxes
#### Canopy N pool
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    canopy_n_pool <- make_canopy_n_pool(n_conc=canopy_n_concentration,
                                        biom=canopy_biomass_pool)
    ### make the plot
    p <- ggplot(canopy_n_pool,
                aes(Date, leaf_n_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("canopy n pool (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```


#### Canopy N flux
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    canopy_n_flux <- make_canopy_n_production(n_conc=canopy_n_concentration,
                                          c_flux=canopy_c_production_flux,
                                          c_frac=c_fraction)
    ### make the plot
    p <- ggplot(canopy_n_flux,
                aes(Date, canopy_n_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("canopy n flux (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```


#### Frass N production
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    frass_n_production <- make_frass_n_production_flux(n_conc=frass_n_concentration,
                                                   c_flux=frass_c_production_flux,
                                                   c_frac=frass_c_fraction)

    ### make the plot
    p <- ggplot(frass_n_production,
                aes(Date, frass_n_flux_mg_m2_d, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("frass n flux (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

#### Soil N pool
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    soil_n_pool <- make_soil_n_pool(n_conc=soil_n_concentration,
                                bk_density=soil_bulk_density)

    ### make the plot
    p <- ggplot(soil_n_pool,
                aes(Date, soil_n_g_m2, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Soil N Pool (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

#### Soil Inorganic N pool

This pool can be obtained based on three possible datasets:

    - Lysimeter 
    - Extractable
    - IEM

Not sure which to use, but to be consistent with phosphate P data, I decided to use the extractable dataset. 

This pool includes nitrate-N, ammonia-N. 

``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    soil_inorganic_n_pool <- make_soil_inorganic_n_pool(n_conc=soil_inorganic_n_concentration,
                                                    bk_density=soil_bulk_density)

    ### make the plot
    p <- ggplot(soil_inorganic_n_pool,
                aes(Date, total_inorganic_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Soil Inorganic N Pool (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

#### Soil nitrification and mineralization flux
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    soil_nitrification_n_flux <- make_soil_n_nitrification_flux(bk_density=soil_bulk_density)

    ### make the plot
    p <- ggplot(soil_nitrification_n_flux,
                aes(Date, soil_n_nitrification_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Soil Nitrification (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

Positive values indicate nitrification, negative indicate denitrification.

``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    soil_mineralization_n_flux <- make_soil_n_mineralization_flux(bk_density=soil_bulk_density)

    ### make the plot
    p <- ggplot(soil_mineralization_n_flux,
                aes(Date, soil_n_mineralization_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Soil Mineralization (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

Positive values are net mineralization, negative are immbolisation. 


#### Understorey N pool
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    understorey_n_pool <- make_understorey_n_pool(n_conc=understorey_n_concentration,
                                              c_pool=understorey_c_pool,
                                              c_frac=c_fraction_ud,
                                              live_or_total = "Live")
    ### make the plot
    p <- ggplot(understorey_n_pool,
                aes(Date, understorey_n_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Understorey N Pool (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

#### Understorey N flux
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    understorey_n_flux <- make_understorey_n_flux(n_conc=understorey_n_concentration,
                                              c_flux=understorey_c_flux,
                                              c_frac=c_fraction_ud)
    ### make the plot
    p <- ggplot(understorey_n_flux,
                aes(Date, understorey_n_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Understorey N Flux (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

### 7.3 N-P limitation indicative variables
#### Canopy N:P ratio
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    canopy_np_ratio <- make_canopy_np_ratios(n_pool=canopy_n_pool,
                                         p_pool=canopy_p_pool)
    ### make the plot
    p <- ggplot(canopy_np_ratio,
                aes(Ring, np_ratio, fill=factor(Ring))) +   
            geom_col() +
            xlab("Ring") + ylab("Canopy N:P")
    plot(p)
```

#### Soil N:P ratios
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    soil_np_ratio <- make_soil_np_ratios(n_pool=soil_n_pool,
                                         p_pool=soil_p_pool)
    ### make the plot
    p <- ggplot(soil_np_ratio,
                aes(Ring, np_ratio, fill=factor(Ring))) +   
            geom_col() +
            xlab("Ring") + ylab("soil N:P")
    plot(p)
```

#### Readily available soil N:P ratios
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    readily_available_soil_np_ratio <- make_readily_available_soil_np_ratios(n_pool=soil_inorganic_n_pool,
                                                                         p_pool=soil_phosphate_pool)
    ### make the plot
    p <- ggplot(readily_available_soil_np_ratio,
                aes(Ring, np_ratio, fill=factor(Ring))) +   
            geom_col() +
            xlab("Ring") + ylab("Readily available soil N:P")
    plot(p)
```


#### Frass N:P ratios
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    frass_np_ratio <- make_frass_np_ratios(n_conc=frass_n_concentration,
                                      p_conc=frass_p_concentration)
    ### make the plot
    p <- ggplot(frass_np_ratio,
                aes(Ring, np_ratio, fill=factor(Ring))) +   
            geom_col() +
            xlab("Ring") + ylab("Frass N:P")
    plot(p)
```

#### Understorey N:P ratios
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    understorey_np_ratio <- make_understorey_np_ratios(n_conc=understorey_n_concentration,
                                      p_conc=understorey_p_concentration)
    ### make the plot
    p <- ggplot(understorey_np_ratio,
                aes(Ring, np_ratio, fill=factor(Ring))) +   
            geom_col() +
            xlab("Ring") + ylab("Frass N:P")
    plot(p)
```

<br/>

# 8. Has anything changed over time?
Here, I will check if there's anything changed over time and if there's any CO2 effect or not. This is quite challenging because:

        1) we don't have common start and end dates across variables; 
        2) variables are measured infrequently, so we cannot ignore seasonal fluctuations; 
        3) biomass estimates and P concentration estimates often do not overlap, creating some range of uncertainties. 


# 9. To-do list

This list is a continuous update of the to-do items for both EucFACE C and P projects. It includes both high and less priority items. 

### High priorities

    - Has C:P ratio change over time (similarly, N:P ratio)?

### Less priorities

    - More valid fine root and coarse root P retranslocation coefficients

### Known missing data


    
### Data uncertainties

    - Microbial pool conversion factor (Cat)
    - How was net P mineralization rate calculated?


<br/>
<br/>
<br/>
