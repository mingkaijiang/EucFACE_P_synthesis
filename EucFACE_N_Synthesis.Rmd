---
title: "EucFACE Nitrogen Synthesis"
author: "Mingkai Jiang"
date: "05/03/2020"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

1. Description
---------------
This is a progress report of the EucFACE nitrogen (N) synthesis project. 

# 2. Methods 
### 2.1 Procedure 
This procedure is a snapshot of the work. It might be easier just to follow the codes. 

    - Create a list of variables for the N synthesis.
    - For each variable, only consider ring, date, and sometimes depth as independent factors.
    - Calculate N concentrations first.
    - With carbon/biomass related variables, calculate N pools and fluxes.
    - Calculate N budgeting variables, e.g. total standing N stock, N retranslocation coefficient, etc.
    - Compute N:P ratios
    - Make summary tables.

### 2.2 Variables
Here, I am summarizing all the N-related pool, flux and concentration variables. 

    - Soil N concentration and pool (ammonia, nitrate, total)
    - Overstorey leaf N concentration, production and pool
    - Wood N concentration, production and pool
    - Fineroot N concentration, production and pool
    - Coarse root N concentration, production and pool
    - Leaf litter N concentration and production
    - N mineralization rate
    - Frass N concentration and production
    - Understorey N concentration, production and pool
    - Standing N stock
    - N requirement
    - Total N retranslocation 
    - Leaf N retranslocation coefficient
    - N uptake
    - N uptake / requirement
    - Mean residence time for N in plants
    - Standing NUE
    

# 3. P concentration calculations. 
``` {r, echo=FALSE, message=FALSE, warning=FALSE}
    ### source the functions to start the calculations.
    source("programs/prepare.R")
    
    ### assign aco2 and eco2 rings
    aCO2_rings <- c(2,3,6)
    eCO2_rings <- c(1,4,5)

```

### 3.1 Canopy N concentration
Canopy N concentration summarized by ring over the experimental period:
``` {r, echo=FALSE, fig.width = 7, fig.align="center"}
    ### calculate the variable
    canopy_n_concentration <- make_canopy_n_concentration()

    ### make the ring over date plot
    p <- ggplot(canopy_n_concentration,
                aes(Date, PercN, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Canopy N Concentration (%)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)

```
Here, canopy N concentration was based on "old" leaf only. 



### 3.2 Wood P concentration
Wood P concentration summarized by treatment, and we only have one date:

``` {r, echo=FALSE, fig.width = 7, fig.align="center"}
    ### calculate the variable
    wood_n_concentration <- make_wood_n_concentration()
    
    ### make the plot
        p <- ggplot(wood_n_concentration,
                aes(Ring, PercN, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Canopy N Concentration (%)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)

```


### 3.3 Fine root N concentration

There are two depths (i.e. 0-10cm, 10-30cm), currently we are averaging the concentrations over depths. 

Fineroot P concentration summarized by treatment over time:

``` {r, echo=FALSE, fig.width = 7, fig.align="center"}
    ### calculate the variable
    fineroot_n_concentration <- make_fineroot_n_concentration()

 
    
    ### make the treatment over date plot
    p <- ggplot(fineroot_n_concentration,
                aes(Date, PercN, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Fineroot N Concentration (%)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)

```


### 3.4 Leaflitter P concentration
Measurements are taken for both scenesced leaves and leaflitter. 
Scenesced leaves are defined as those that are still (barely) attached to the tree, so there is a tree ID associated with each measurement. 
Leaflitter are those collected from the litter baskets.

Note, these samples were not taken on the same date; nor were they taken on the same dates as the fresh green leaves. 

We firstly need to distinguish the difference between the two. 

``` {r, echo=FALSE, warning=FALSE, fig.width = 7, fig.align="center"}
        ### calculate the variable
    leaflitter_p_concentration <- make_leaflitter_p_concentration_new(func=mean)

    ### make the ring over date plot
    p <- ggplot(leaflitter_p_concentration,
                aes(Date, PercP, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Leaflitter P Concentration (%)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

Next, both leaflitter and senesced leaves were grouped together as leaflitter. 
The CO2 by date plot is:

``` {r, echo=FALSE, fig.width = 7, fig.align="center"}
 
    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        leaflitter_p_concentration[leaflitter_p_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        leaflitter_p_concentration[leaflitter_p_concentration$Ring == i, "CO2"] <- "eCO2"
    }
    
    ### make the treatment over date plot
    p <- ggplot(leaflitter_p_concentration,
                aes(Date, PercP, color=factor(CO2))) +   
            geom_point(size = 5) + 
            xlab("Date") + ylab("Leaflitter P Concentration (%)")
    plot(p)

```

<br/>
<br/>


# 7. Nitrogen related data to understand P limitation
### 7.1 Concentrations
#### Canopy N concentration
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    canopy_n_concentration <- make_canopy_n_concentration()

    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        canopy_n_concentration[canopy_n_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        canopy_n_concentration[canopy_n_concentration$Ring == i, "CO2"] <- "eCO2"
    }

    ### make the treatment over date plot
    p <- ggplot(canopy_n_concentration,
                aes(Date, PercN, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Canopy N Concentration (%)")
    plot(p)

```


#### Frass N concentration
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    frass_n_concentration <- make_frass_n_concentration()

    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        frass_n_concentration[frass_n_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        frass_n_concentration[frass_n_concentration$Ring == i, "CO2"] <- "eCO2"
    }

    ### make the treatment over date plot
    p <- ggplot(frass_n_concentration,
                aes(Date, PercN, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Frass N Concentration (%)")
    plot(p)

```

#### Soil N concentration
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    soil_n_concentration <- make_soil_n_concentration()

    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        soil_n_concentration[soil_n_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        soil_n_concentration[soil_n_concentration$Ring == i, "CO2"] <- "eCO2"
    }

    ### make the treatment over date plot
    p <- ggplot(soil_n_concentration,
                aes(Date, PercN, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Soil N Concentration (%)")
    plot(p)

```

#### Soil Inorganic N concentration

This concentration can be obtained based on three possible datasets:

    - Lysimeter 
    - Extractable
    - IEM

Not sure which to use, but to be consistent with phosphate P data, I decided to use the extractable dataset. 

This pool includes nitrate-N, ammonia-N. 

``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    soil_inorganic_n_concentration <- make_soil_inorganic_n_concentration()

    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        soil_inorganic_n_concentration[soil_inorganic_n_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        soil_inorganic_n_concentration[soil_inorganic_n_concentration$Ring == i, "CO2"] <- "eCO2"
    }

    ### make the treatment over date plot
    p <- ggplot(soil_inorganic_n_concentration,
                aes(Date, Total_PercN, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Soil Inorganic N Concentration (%)")
    plot(p)

```


#### Understorey N concentration
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    understorey_n_concentration <- make_understorey_n_concentration()

    ### assign CO2 treatment labels
    for (i in aCO2_rings) {
        understorey_n_concentration[understorey_n_concentration$Ring == i, "CO2"] <- "aCO2"
    }
    for (i in eCO2_rings) {
        understorey_n_concentration[understorey_n_concentration$Ring == i, "CO2"] <- "eCO2"
    }

    ### make the treatment over date plot
    p <- ggplot(understorey_n_concentration,
                aes(Date, PercN, color=factor(CO2))) +   
            geom_point(size = 5) +
            xlab("Date") + ylab("Understorey N Concentration (%)")
    plot(p)

```

<br/>

### 7.2 Pools and fluxes
#### Canopy N pool
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    canopy_n_pool <- make_canopy_n_pool(n_conc=canopy_n_concentration,
                                        biom=canopy_biomass_pool)
    ### make the plot
    p <- ggplot(canopy_n_pool,
                aes(Date, leaf_n_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("canopy n pool (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```


#### Canopy N flux
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    canopy_n_flux <- make_canopy_n_production(n_conc=canopy_n_concentration,
                                          c_flux=canopy_c_production_flux,
                                          c_frac=c_fraction)
    ### make the plot
    p <- ggplot(canopy_n_flux,
                aes(Date, canopy_n_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("canopy n flux (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```


#### Frass N production
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    frass_n_production <- make_frass_n_production_flux(n_conc=frass_n_concentration,
                                                   c_flux=frass_c_production_flux,
                                                   c_frac=frass_c_fraction)

    ### make the plot
    p <- ggplot(frass_n_production,
                aes(Date, frass_n_flux_mg_m2_d, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("frass n flux (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

#### Soil N pool
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    soil_n_pool <- make_soil_n_pool(n_conc=soil_n_concentration,
                                bk_density=soil_bulk_density)

    ### make the plot
    p <- ggplot(soil_n_pool,
                aes(Date, soil_n_g_m2, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Soil N Pool (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

#### Soil Inorganic N pool

This pool can be obtained based on three possible datasets:

    - Lysimeter 
    - Extractable
    - IEM

Not sure which to use, but to be consistent with phosphate P data, I decided to use the extractable dataset. 

This pool includes nitrate-N, ammonia-N. 

``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    soil_inorganic_n_pool <- make_soil_inorganic_n_pool(n_conc=soil_inorganic_n_concentration,
                                                    bk_density=soil_bulk_density)

    ### make the plot
    p <- ggplot(soil_inorganic_n_pool,
                aes(Date, total_inorganic_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Soil Inorganic N Pool (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

#### Soil nitrification and mineralization flux
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    soil_nitrification_n_flux <- make_soil_n_nitrification_flux(bk_density=soil_bulk_density)

    ### make the plot
    p <- ggplot(soil_nitrification_n_flux,
                aes(Date, soil_n_nitrification_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Soil Nitrification (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

Positive values indicate nitrification, negative indicate denitrification.

``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    soil_mineralization_n_flux <- make_soil_n_mineralization_flux(bk_density=soil_bulk_density)

    ### make the plot
    p <- ggplot(soil_mineralization_n_flux,
                aes(Date, soil_n_mineralization_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Soil Mineralization (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

Positive values are net mineralization, negative are immbolisation. 


#### Understorey N pool
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    understorey_n_pool <- make_understorey_n_pool(n_conc=understorey_n_concentration,
                                              c_pool=understorey_c_pool,
                                              c_frac=c_fraction_ud,
                                              live_or_total = "Live")
    ### make the plot
    p <- ggplot(understorey_n_pool,
                aes(Date, understorey_n_pool, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Understorey N Pool (g m-2)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

#### Understorey N flux
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    understorey_n_flux <- make_understorey_n_flux(n_conc=understorey_n_concentration,
                                              c_flux=understorey_c_flux,
                                              c_frac=c_fraction_ud)
    ### make the plot
    p <- ggplot(understorey_n_flux,
                aes(Date, understorey_n_flux, color=factor(Ring))) +   
            geom_point(size = 5) + geom_line() + 
            xlab("Date") + ylab("Understorey N Flux (mg m-2 d-1)") + 
            scale_color_manual(values=c("#FF7F50", "#00FFFF", "#6495ED",
                                        "#FF4040", "#8B0000", "#0000FF"))
    plot(p)
```

### 7.3 N-P limitation indicative variables
#### Canopy N:P ratio
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    canopy_np_ratio <- make_canopy_np_ratios(n_pool=canopy_n_pool,
                                         p_pool=canopy_p_pool)
    ### make the plot
    p <- ggplot(canopy_np_ratio,
                aes(Ring, np_ratio, fill=factor(Ring))) +   
            geom_col() +
            xlab("Ring") + ylab("Canopy N:P")
    plot(p)
```

#### Soil N:P ratios
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    soil_np_ratio <- make_soil_np_ratios(n_pool=soil_n_pool,
                                         p_pool=soil_p_pool)
    ### make the plot
    p <- ggplot(soil_np_ratio,
                aes(Ring, np_ratio, fill=factor(Ring))) +   
            geom_col() +
            xlab("Ring") + ylab("soil N:P")
    plot(p)
```

#### Readily available soil N:P ratios
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    readily_available_soil_np_ratio <- make_readily_available_soil_np_ratios(n_pool=soil_inorganic_n_pool,
                                                                         p_pool=soil_phosphate_pool)
    ### make the plot
    p <- ggplot(readily_available_soil_np_ratio,
                aes(Ring, np_ratio, fill=factor(Ring))) +   
            geom_col() +
            xlab("Ring") + ylab("Readily available soil N:P")
    plot(p)
```


#### Frass N:P ratios
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    frass_np_ratio <- make_frass_np_ratios(n_conc=frass_n_concentration,
                                      p_conc=frass_p_concentration)
    ### make the plot
    p <- ggplot(frass_np_ratio,
                aes(Ring, np_ratio, fill=factor(Ring))) +   
            geom_col() +
            xlab("Ring") + ylab("Frass N:P")
    plot(p)
```

#### Understorey N:P ratios
``` {r, echo=FALSE, fig.width = 7, fig.align="center", warning=FALSE, message=FALSE} 
    understorey_np_ratio <- make_understorey_np_ratios(n_conc=understorey_n_concentration,
                                      p_conc=understorey_p_concentration)
    ### make the plot
    p <- ggplot(understorey_np_ratio,
                aes(Ring, np_ratio, fill=factor(Ring))) +   
            geom_col() +
            xlab("Ring") + ylab("Frass N:P")
    plot(p)
```

<br/>

# 8. Has anything changed over time?
Here, I will check if there's anything changed over time and if there's any CO2 effect or not. This is quite challenging because:

        1) we don't have common start and end dates across variables; 
        2) variables are measured infrequently, so we cannot ignore seasonal fluctuations; 
        3) biomass estimates and P concentration estimates often do not overlap, creating some range of uncertainties. 


# 9. To-do list

This list is a continuous update of the to-do items for both EucFACE C and P projects. It includes both high and less priority items. 

### High priorities

    - Has C:P ratio change over time (similarly, N:P ratio)?

### Less priorities

    - More valid fine root and coarse root P retranslocation coefficients

### Known missing data


    
### Data uncertainties

    - Microbial pool conversion factor (Cat)
    - How was net P mineralization rate calculated?


<br/>
<br/>
<br/>
